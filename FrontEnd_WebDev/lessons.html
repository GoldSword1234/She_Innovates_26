<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lessons â€” She Innovates</title>

  <link rel="stylesheet" href="styles.css">

  <style>
    /* --- clickable lesson card behavior --- */
    .lesson-link {
      display: block;
      text-decoration: none;
      color: inherit;
    }

    .lesson-link:hover {
      cursor: pointer;
      filter: brightness(1.05);
    }

    .lesson-link:focus-visible {
      outline: 3px solid #fff;
      outline-offset: 4px;
    }
  </style>
</head>

<body>
  <h1 id="pageTitle" style="text-align:center;">Lessons</h1>

  <!-- modules + lessons injected here -->
  <div id="modulesRoot"></div>
  </main>

       <main class="navigation-row">
        <div class="image-row">
          <button class = "btn" onclick="goToHome()">
        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill=#fff class="bi bi-house-door" viewBox="0 0 16 16">
            <path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4z"/>
        </svg>
      </button>
        </div>

        <div class = "image-row">
            <button class = "btn" onclick="goToModules()">
                <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill=#fff class="bi bi-book" viewBox="0 0 16 16">
                    <path d="M1 2.828c.885-.37 2.154-.769 3.388-.893 1.33-.134 2.458.063 3.112.752v9.746c-.935-.53-2.12-.603-3.213-.493-1.18.12-2.37.461-3.287.811zm7.5-.141c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388.893v9.923c-.918-.35-2.107-.692-3.287-.81-1.094-.111-2.278-.039-3.213.492zM8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.68-1.02 1.409-.142 2.59.087 3.223.877a.5.5 0 0 0 .78 0c.633-.79 1.814-1.019 3.222-.877 1.378.139 2.8.62 3.681 1.02A.5.5 0 0 0 16 13.5v-11a.5.5 0 0 0-.293-.455c-.952-.433-2.48-.952-3.994-1.105C10.413.809 8.985.936 8 1.783"/>
                </svg>
            </button>
        </div>
        
        <div class="image-row">
            <button class = "btn" onclick="goToBadges()">
        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill=#fff class="bi bi-award" viewBox="0 0 16 16">
            <path d="M9.669.864 8 0 6.331.864l-1.858.282-.842 1.68-1.337 1.32L2.6 6l-.306 1.854 1.337 1.32.842 1.68 1.858.282L8 12l1.669-.864 1.858-.282.842-1.68 1.337-1.32L13.4 6l.306-1.854-1.337-1.32-.842-1.68zm1.196 1.193.684 1.365 1.086 1.072L12.387 6l.248 1.506-1.086 1.072-.684 1.365-1.51.229L8 10.874l-1.355-.702-1.51-.229-.684-1.365-1.086-1.072L3.614 6l-.25-1.506 1.087-1.072.684-1.365 1.51-.229L8 1.126l1.356.702z"/>
            <path d="M4 11.794V16l4-1 4 1v-4.206l-2.018.306L8 13.126 6.018 12.1z"/>
        </svg>
        </button>
        </div>
        
        <div class="image-row">
          <button class = "btn" onclick="goToProfile()">
        <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill=#fff class="bi bi-person-circle" viewBox="0 0 16 16">
            <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
            <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
        </svg>
        </button>
        </div>
    </main>

  <script>
    function goToHome() {
      window.location.href = "home.html"; // Replace with your target URL
    }

    function goToModules() {
      window.location.href = "modules.html"; // Replace with your target URL
    }

    function goToFinance() {
      window.location.href = "finance_module.html"; // Replace with your target URL
    }

    function goToSavingInvesting() {
      window.location.href = "saving_investing_101.html"; // Replace with your target URL
    }

    function goToBadges() {
      window.location.href = "badges.html"; // Replace with your target URL
    }

    function goToProfile() {
        window.location.href = "profile.html";
    }
    
    const API_BASE = "https://api.jgao.cc";

    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const moduletype = params.get("moduletype") || "Finance";

      document.getElementById("pageTitle").textContent =
        `${moduletype} Lessons`;

      loadLessons(moduletype);
    });

    async function loadLessons(moduletype) {
      const root = document.getElementById("modulesRoot");
      root.innerHTML = "";

      try {
        const url = new URL(`${API_BASE}/GetTasks`);
        url.searchParams.set("moduletype", moduletype);

        const res = await fetch(url, {
          credentials: "include",
          headers: { "Accept": "application/json" }
        });

        if (!res.ok) throw new Error("Failed to load lessons");

        const data = await res.json();
        const lessons = data?.[0]?.lessons ?? [];

        if (!lessons.length) {
          root.innerHTML = "<p style='text-align:center;'>No lessons found.</p>";
          return;
        }

        renderLessons(lessons, root);

      } catch (err) {
        console.error(err);
        root.innerHTML =
          `<p style="text-align:center;">Error loading lessons.</p>`;
      }
    }

    function renderLessons(lessons, root) {
      const grouped = groupBy(lessons, l => l.modulename || "Module");

      Object.entries(grouped).forEach(([moduleName, moduleLessons], idx) => {

        /* ---- module header ---- */
        const moduleDiv = document.createElement("div");
        moduleDiv.className = "module";
        moduleDiv.innerHTML = `<h2>Module ${idx + 1}: ${escapeHtml(moduleName)}</h2>`;
        root.appendChild(moduleDiv);

        const container = document.createElement("div");
        container.className = "lesson-container";

        moduleLessons
          .sort((a, b) => (a.lessonid ?? 0) - (b.lessonid ?? 0))
          .forEach((lesson, lessonIdx) => {

            const lessonTitle =
              `Lesson ${lessonIdx + 1}: ${lesson.lesson_description || "Untitled Lesson"}`;

            const videoUrl =
              Array.isArray(lesson.tasks)
                ? (lesson.tasks.find(t => t?.URL)?.URL ?? "")
                : "";

            const lessonLink = document.createElement("a");
            lessonLink.className = "lesson lesson-link";
            lessonLink.href = videoUrl || "#";
            lessonLink.target = "_blank";
            lessonLink.rel = "noopener noreferrer";
            lessonLink.setAttribute("aria-label", lessonTitle);

            if (!videoUrl) {
              lessonLink.addEventListener("click", e => {
                e.preventDefault();
                alert("No video available for this lesson.");
              });
            }

            lessonLink.innerHTML = `
              <h2>
                ${escapeHtml(lessonTitle)}
                <div class="lesson-corner-icon">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       width="30" height="30" fill="#fff"
                       class="bi bi-arrow-right-circle-fill"
                       viewBox="0 0 16 16">
                    <path d="M8 0a8 8 0 1 1 0 16
                             A8 8 0 0 1 8 0M4.5 7.5
                             a.5.5 0 0 0 0 1h5.793
                             l-2.147 2.146a.5.5 0 0 0
                             .708.708l3-3a.5.5 0 0 0
                             0-.708l-3-3a.5.5 0 1 0
                             -.708.708L10.293 7.5z"/>
                  </svg>
                </div>
              </h2>
            `;

            container.appendChild(lessonLink);
          });

        root.appendChild(container);
      });
    }

    /* ---- helpers ---- */
    function groupBy(arr, keyFn) {
      return arr.reduce((acc, item) => {
        const key = String(keyFn(item));
        (acc[key] ||= []).push(item);
        return acc;
      }, {});
    }

    function escapeHtml(str) {
      return String(str ?? "").replace(/[&<>"']/g, m => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      }[m]));
    }
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lessons â€” She Innovates</title>

  <link rel="stylesheet" href="styles.css">

  <style>
    /* --- clickable lesson card behavior --- */
    .lesson-link {
      display: block;
      text-decoration: none;
      color: inherit;
    }

    .lesson-link:hover {
      cursor: pointer;
      filter: brightness(1.05);
    }

    .lesson-link:focus-visible {
      outline: 3px solid #fff;
      outline-offset: 4px;
    }
  </style>
</head>

<body>
  <h1 id="pageTitle" style="text-align:center;">Lessons</h1>

  <!-- modules + lessons injected here -->
  <div id="modulesRoot"></div>

  <script>
    const API_BASE = "https://api.jgao.cc";

    document.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);
      const moduletype = params.get("moduletype") || "Finance";

      document.getElementById("pageTitle").textContent =
        `${moduletype} Lessons`;

      loadLessons(moduletype);
    });

    async function loadLessons(moduletype) {
      const root = document.getElementById("modulesRoot");
      root.innerHTML = "";

      try {
        const url = new URL(`${API_BASE}/GetTasks`);
        url.searchParams.set("moduletype", moduletype);

        const res = await fetch(url, {
          credentials: "include",
          headers: { "Accept": "application/json" }
        });

        if (!res.ok) throw new Error("Failed to load lessons");

        const data = await res.json();
        const lessons = data?.[0]?.lessons ?? [];

        if (!lessons.length) {
          root.innerHTML = "<p style='text-align:center;'>No lessons found.</p>";
          return;
        }

        renderLessons(lessons, root);

      } catch (err) {
        console.error(err);
        root.innerHTML =
          `<p style="text-align:center;">Error loading lessons.</p>`;
      }
    }

    function renderLessons(lessons, root) {
      const grouped = groupBy(lessons, l => l.modulename || "Module");

      Object.entries(grouped).forEach(([moduleName, moduleLessons], idx) => {

        /* ---- module header ---- */
        const moduleDiv = document.createElement("div");
        moduleDiv.className = "module";
        moduleDiv.innerHTML = `<h2>Module ${idx + 1}: ${escapeHtml(moduleName)}</h2>`;
        root.appendChild(moduleDiv);

        const container = document.createElement("div");
        container.className = "lesson-container";

        moduleLessons
          .sort((a, b) => (a.lessonid ?? 0) - (b.lessonid ?? 0))
          .forEach((lesson, lessonIdx) => {

            const lessonTitle =
              `Lesson ${lessonIdx + 1}: ${lesson.lesson_description || "Untitled Lesson"}`;

            const videoUrl =
              Array.isArray(lesson.tasks)
                ? (lesson.tasks.find(t => t?.URL)?.URL ?? "")
                : "";

            const lessonLink = document.createElement("a");
            lessonLink.className = "lesson lesson-link";
            lessonLink.href = videoUrl || "#";
            lessonLink.target = "_blank";
            lessonLink.rel = "noopener noreferrer";
            lessonLink.setAttribute("aria-label", lessonTitle);

            if (!videoUrl) {
              lessonLink.addEventListener("click", e => {
                e.preventDefault();
                alert("No video available for this lesson.");
              });
            }

            lessonLink.innerHTML = `
              <h2>
                ${escapeHtml(lessonTitle)}
                <div class="lesson-corner-icon">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       width="30" height="30" fill="#fff"
                       class="bi bi-arrow-right-circle-fill"
                       viewBox="0 0 16 16">
                    <path d="M8 0a8 8 0 1 1 0 16
                             A8 8 0 0 1 8 0M4.5 7.5
                             a.5.5 0 0 0 0 1h5.793
                             l-2.147 2.146a.5.5 0 0 0
                             .708.708l3-3a.5.5 0 0 0
                             0-.708l-3-3a.5.5 0 1 0
                             -.708.708L10.293 7.5z"/>
                  </svg>
                </div>
              </h2>
            `;

            container.appendChild(lessonLink);
          });

        root.appendChild(container);
      });
    }

    /* ---- helpers ---- */
    function groupBy(arr, keyFn) {
      return arr.reduce((acc, item) => {
        const key = String(keyFn(item));
        (acc[key] ||= []).push(item);
        return acc;
      }, {});
    }

    function escapeHtml(str) {
      return String(str ?? "").replace(/[&<>"']/g, m => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;"
      }[m]));
    }
  </script>
</body>
</html>
